<!-- resultados.html -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERGORICE - Rula Resultados</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Otros estilos si es necesario -->
    <!-- LOGO -->
    <link href="{{ url_for('static', filename='imagenes/logo.png') }}" rel="icon">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <script src="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet"></script> 

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Customized Bootstrap Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='js/scripts.js') }}">
</head>
<body class="bg-light">
    <!-- Topbar Start -->
    <div class="container-fluid bg-light pt-3 d-none d-lg-block">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 text-center text-lg-left mb-2 mb-lg-0">
                    <div class="d-inline-flex align-items-center">
                        <p><i class="fa fa-envelope mr-2"></i>ergo-rice@hotmail.com</p>
                        <p class="text-body px-3">|</p>
                        <p><i class="fa fa-phone-alt mr-2"></i>+593 0982028735</p>
                    </div>
                </div>
                <div class="col-lg-6 text-center text-lg-right">
                    <div class="d-inline-flex align-items-center">                        
                        <a id= "salir" class="text-primary pl-3" href="cerrar_sesion">Cerrar Sesión
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Topbar End -->    
    <!-- Navbar Start -->
    <div class="container-fluid position-relative nav-bar p-0">
        <div class="container-lg position-relative p-0 px-lg-3" style="z-index: 9;">
            <nav class="navbar navbar-expand-lg bg-light navbar-light shadow-lg py-3 py-lg-0 pl-3 pl-lg-5">
                <img src="{{ url_for('static', filename='imagenes/logo.png') }}" width="90" height="90">
                <a href="" class="navbar-brand">
                    <h1 class="m-0 text-primary"><span class="text-dark">ERGO</span>RICE</h1>
                </a>                                                
            </nav>
        </div>
    </div>
    <!-- Navbar End -->    
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="contact-form bg-white" style="padding: 0px;">    
                <div class="card-header bg-primary text-center p-4">
                    <h1 class="text-white m-0">RESULTADOS METODO RULA</h1>                    
                </div>
                <a href="/home" class="btn btn-primary">Vover a Evaluar</a>
                <a href="/get_angulos" class="btn btn-primary">Ver Ángulos</a>                    
                <div class="d-flex justify-content-center" style="padding: 3px;">
                    <h4>¿Guardar datos y actualizar T.RULA TC?</h4>
                    <button class="btn btn-info" onclick="rula_guardarTC()">Actualizar</button>
                </div>
                <div class="d-flex justify-content-center" style="padding: 3px;">
                    <h4>¿Guardar datos y actualizar T.RULA RESULTADOS?</h4>
                    <button class="btn btn-info" onclick="rula_guardarResultados()">Actualizar</button>
                </div>    
                <div class="d-flex justify-content-center" style="padding: 3px;">
                    <a href="{{ url_for('descargar_excel_rula') }}" class="btn btn-success">Descargar Excel</a>
                    <a href="{{ url_for('descargar_pdf_rula') }}" class="btn btn-danger">Descargar Pdf</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Blog Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="row">
                <div class="col-lg-8">
                    <!-- Blog Detail Start -->
                    <div class="pb-3">
                        <div class="bg-white mb-3" style="padding: 10px;"> 
                            <table border="1">
                                <thead>
                                    <tr>
                                        <th colspan="4" style="text-align: left;">Evaluador: 
                                            {% if usuario %}
                                                {% for user in usuario %}
                                                    {{ user.nombres }} {{ user.apellidos }}
                                                {% endfor %}                                        
                                            {% endif %}
                                        </th>
                                        <th colspan="4" style="text-align: left;">Método:
                                            {% if session %}                                                                                         
                                                {{ session['metodo_evaluacion'] }}
                                            {% endif %}                                                                                                                                    
                                        </th>   
                                    </tr>
                                    <tr>
                                        {% if session %}
                                            <th colspan="4" style="text-align: left;">Puesto del trabajador:                                                                                         
                                                {{ session['npuesto'] }}                                                                                                                                    
                                            </th>
                                            <th colspan="4" style="text-align: left;">Trabajador:                                                                                         
                                                {{ session['nom_trabajador'] }}                                                                                                                                    
                                            </th>
                                        {% endif %}   
                                    </tr>
                                    <tr>
                                        <th>Segundo</th>
                                        <th>P.RULA GA</th>
                                        <th>P.RULA GB</th>
                                        <th>T.RULA GA</th>
                                        <th>T.RULA GB</th>
                                        <th>T.RULA TC</th>
                                        <th>T.RULA RESULTADOS</th>
                                        <th>FOTOGRAMAS</th>
                                        <!-- Agrega aquí los demás encabezados de columna según sea necesario -->
                                    </tr>
                                </thead>        
                                <tbody>
                                    {% for entry in data %}
                                        <tr>
                                            <td>{{ entry['Segundo'] }}</td>
                                            <td>{{ entry['P.RULA GA'] }}</td>
                                            <td>{{ entry['P.RULA GB'] }}</td>
                                            <td contenteditable="true" id="t-rula-ga-{{ entry['Segundo'] }}">{{ entry['T.RULA GA'] }}</td>
                                            <td contenteditable="true" id="t-rula-gb-{{ entry['Segundo'] }}">{{ entry['T.RULA GB'] }}</td>
                                            <td contenteditable="true" id="t-rula-tc-{{ entry['Segundo'] }}">{{ entry['T.RULA TC'] }}</td>
                                            <td>{{ entry['T.RULA RESULTADOS']}}</td>
                                            <td class="img-cell"><img src="{{ entry['Fotogramas'] }}" alt="Fotograma"></td>
                                            <!-- Agrega aquí las demás celdas de datos según sea necesario -->
                                        </tr>                
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- INFORMACIÓN -->
                <div class="col-lg-4 mt-5 mt-lg-0">                
                    <div class="card border-0">
                        <div class="card-header bg-primary text-center p-4">
                            <h1 class="text-white m-0">Ten en cuenta</h1>
                        </div>
                        <div class="bg-white mb-3" style="padding: 3px;">                            
                            <h3 class="mb-2">Puedes modificar los valores y resultados segun las condiciones de RULA</h3>
                        </div>
                        <div class="bg-white mb-3" style="padding: 5px;">                                                        
                            <p>Luego de realizar cualquier cambio en las columnas recuerda siempre <b>Actualizar T.RULA RESULTADOS</b>
                            </p>                            
                        </div>                        
                        <div class="bg-white mb-3" style="padding: 5px;">                                                        
                            <p>La puntuación de los Grupos A y B se incrementarán en un punto (+1) si la actividad es básicamente estática 
                                (la postura se mantiene más de un minuto seguido) o bien si es repetitiva (se repite más de 4 veces cada minuto). 
                                Si la tarea es ocasional, poco frecuente y de corta duración, se considerará actividad dinámica y las puntuaciones no se modificarán.
                                Por otra parte se incrementarán las puntuaciones anteriores en función de las fuerzas ejercidas como se muestra en la siguiente imagen. No olvidar dar clic en <b>Actualizar</b> de T.RULA TC
                            </p>                            
                        </div>
                        <div class="blog-item">
                            <div class="position-relative">
                                <img class="img-fluid w-100" src="{{ url_for('static', filename='imagenes/rula_fuerzas.png') }}" alt="">                                
                            </div>
                        </div>                        
                    </div>
                </div>
            </div>
        </div>    
    </div>
    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 py-5 px-sm-3 px-lg-5" style="margin-top: 90px;">
        <div class="row pt-5">
            <div class="col-lg-4 col-md-6 mb-5">
                <a href="" class="navbar-brand">
                    <h1 class="text-primary"><span class="text-white">ERGO</span>RICE</h1>
                </a>
                <p>Realiza evaluaciones de posturas ergonómicas de forma rápida y sencilla.</p>                
            </div>            
            <div class="col-lg-4 col-md-6 mb-5">
                <h5 class="text-white text-uppercase mb-4" style="letter-spacing: 5px;">Enlaces rápidos</h5>
                <div class="d-flex flex-column justify-content-start">
                    <a class="text-white-50 mb-2" href="/registro"><i class="fa fa-angle-right mr-2"></i>Registrarse</a>
                    <a class="text-white-50 mb-2" href="/login"><i class="fa fa-angle-right mr-2"></i>Iniciar sesión</a>
                    <a class="text-white-50 mb-2" href="/manual"><i class="fa fa-angle-right mr-2"></i>Manual</a>
                    <a class="text-white-50 mb-2" href="/ejemplos"><i class="fa fa-angle-right mr-2"></i>Ejemplos</a>
                    <a class="text-white-50 mb-2" href="/info_reba"><i class="fa fa-angle-right mr-2"></i>Reba</a>
                    <a class="text-white-50 mb-2" href="/info_rula"><i class="fa fa-angle-right mr-2"></i>Rula</a>                    
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-5">
                <h5 class="text-white text-uppercase mb-4" style="letter-spacing: 5px;">Contáctanos</h5>                
                <p><i class="fa fa-phone-alt mr-2"></i>+593 0982028735</p>
                <p><i class="fa fa-envelope mr-2"></i>ergo-rice@hotmail.com</p>                                
            </div>
        </div>
    </div>
    <div class="container-fluid bg-dark text-white border-top py-4 px-sm-3 px-md-5" style="border-color: rgba(256, 256, 256, .1) !important;">
        <div class="row">
            <div class="col-lg-12 text-center text-md-left mb-3 mb-md-0">
                <p class="m-0 text-white-50">Copyright &copy; <a href="#">ergorice</a>. All Rights Reserved.</a>
                </p>
            </div>            
        </div>
    </div>
    <!-- Footer End -->


    <!-- Back to Top -->
    <a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i class="fa fa-angle-double-up"></i></a>
    
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        // Utilizamos history.pushState() para agregar una entrada al historial del navegador
        history.pushState(null, null, location.href);
        window.onpopstate = function(event) {
            // Redirigimos al usuario a la página "otra_pagina.html"
            window.location.href = "/home";
        };        
        // Obtener todas las celdas de las columnas deseadas
        var celdas = document.querySelectorAll('td:nth-child(4), td:nth-child(5), td:nth-child(6)'); // Cambia los números por los números de las columnas que quieras editar

        // Agregar evento de teclado a cada celda
        celdas.forEach(function(celda) {
        celda.contentEditable = true; // Hacer la celda editable
        var vinicial = parseInt(celda.innerHTML);
        celda.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowUp') {
            // Aumentar el valor en la celda
                var valorActual = parseInt(celda.innerHTML);                
                var limite = 3;
                if (valorActual < (limite + vinicial)) {
                    celda.innerHTML = valorActual + 1;
                }
            } else if (event.key === 'ArrowDown') {
                var valorActual = parseInt(celda.innerHTML);
            // Disminuir el valor en la celda
                if (valorActual > vinicial) {
                    celda.innerHTML = valorActual - 1;
                }
                event.preventDefault(); // Cancelar la acción predeterminada para evitar la escritura
            } else if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight' && event.key !== 'ArrowUp' && event.key !== 'ArrowDown') {
            event.preventDefault(); // Cancelar la acción predeterminada si se presiona una tecla que no sea una flecha
            }
        });
        });        

        function rula_guardarTC() {
            // Obtiene los nuevos valores de las celdas editables de T.REBA GA
            var nuevoGA = {};
            var nuevoGB = {};

            $('td[id^="t-rula-ga-"]').each(function() {
                var segundo = $(this).attr('id').split('-')[3];  // Obtiene el segundo desde el ID
                var valor = $(this).text();
                nuevoGA[segundo] = valor;
            });

            $('td[id^="t-rula-gb-"]').each(function() {
                var segundo = $(this).attr('id').split('-')[3];  // Obtiene el segundo desde el ID
                var valor = $(this).text();
                nuevoGB[segundo] = valor;
            });
            
            // Realiza una solicitud AJAX al servidor para guardar los cambios
            $.ajax({
                type: 'POST',
                url: '/rula_guardar_cambios',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({ nuevoGA: nuevoGA, nuevoGB: nuevoGB }),
                success: function (response) {
                    // Maneja la respuesta del servidor (puede ser simplemente un mensaje de éxito)
                    console.log(response);
                },
                error: function (error) {
                    // Maneja errores, si los hay
                    console.error(error);
                }
            });
            // Recarga la página después de guardar los cambios
            location.reload();
        }
        function rula_guardarResultados() {
            // Obtiene los nuevos valores de las celdas editables de T.REBA GA
            var nuevoTC = {};            

            $('td[id^="t-rula-tc-"]').each(function() {
                var segundo = $(this).attr('id').split('-')[3];  // Obtiene el segundo desde el ID
                var valor = $(this).text();
                nuevoTC[segundo] = valor;
            });            
            
            // Realiza una solicitud AJAX al servidor para guardar los cambios
            $.ajax({
                type: 'POST',
                url: '/rula_guardar_cambios_tc',
                contentType: 'application/json;charset=UTF-8',
                data: JSON.stringify({ nuevoTC: nuevoTC }),
                success: function (response) {
                    // Maneja la respuesta del servidor (puede ser simplemente un mensaje de éxito)
                    console.log(response);
                    location.reload();
                },
                error: function (error) {
                    // Maneja errores, si los hay
                    console.error(error);
                }
            });
        }
    </script>     
</body>
</html>
